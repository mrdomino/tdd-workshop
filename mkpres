#!/bin/sh

PRES_MD=$(mktemp -t pres.md)
GIT_TMP=$(mktemp -d /tmp/repo.XXXXXX)
trap "rm -rf $PRES_MD $GIT_TMP" EXIT

function git_diff_py {
  local commit=$1
  local file=$2
  local diff=$(git diff $commit^..$commit -- $file)
  if [ "$(git diff $commit^..$commit -- $file 2>/dev/null)" ]
  then
    echo $'```python'
    echo "# $(basename $file)"
    git diff $commit^..$commit -- $file | sed '1,4d' | sed '/^@@.*@@$/d'
    echo $'```'
  fi
}

function git_show_py {
  local commit=$1
  local file=$2
  if git show $commit:$file >/dev/null 2>&1
  then
    echo $'```python'
    echo "# $(basename $file)"
    git show $commit:$file
    echo $'```'
  fi
}

function echo_nose {
  local commit=$1
  ( rm -rf "$GIT_TMP/commit" &&
    git clone --reference "$PWD" "$PWD" "$GIT_TMP/commit" >/dev/null 2>&1 &&
    cd "$GIT_TMP/commit" &&
    git checkout $commit >/dev/null 2>&1 &&
    echo $'```'
    echo $'$ nosetests'
    nosetests 2>&1
    echo $'```'
  )
}

function gen_code_a {
  local commit=$1
  git_show_py $commit src/leaderboard.py
  git_show_py $commit test/test_leaderboard.py
}

function gen_code_b {
  local commit=$1
  git_show_py $commit src/leaderboard.py
  git_diff_py $commit test/test_leaderboard.py
}

function gen_code_c {
  local commit=$1
  git_diff_py $commit src/leaderboard.py
  git_diff_py $commit test/test_leaderboard.py
}

function gen {
  local fn=$1
  local range=$2
  for commit in $(git rev-list $range | tail -r)
  do
    echo $commit >&2
    echo ---
    git log --format=$'# %s\n\n%b' -n 1 $commit
    $fn $commit
    echo_nose $commit
  done
}

function gen_md {
  { gen gen_code_a ..gen-a
    gen gen_code_b gen-a..gen-b
    gen gen_code_c gen-b..master
  } | sed '1d' > $PRES_MD
}

{ gen_md &&
  vim $PRES_MD &&
  cat $PRES_MD > pres.md &&
  sed -e '/^MARKDOWN GOES HERE$/{
    r pres.md
    d
  }' remark.html > $PRES_MD &&
  mv $PRES_MD index.html &&
  open index.html
}
